---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by likai.
--- DateTime: 2020-05-26 11:45
--- 与服务器通信管理

NM = {}

NM.PushNewChatMsg = "push@newChatMsg"

NM.login = {"core@login", "playerName"}
local cjson = require("cjson")

---发包
function NM.Send(action, callBack, ...)
    if NM.ins.connected ~= true then
        networkMgr:Connect()
        NM.ins.connected = true
    end
    NM.ins:SendRequest(action, callBack, ...)
end

---注册侦听推送
function NM.AddListenerPush(action, callBack)
    NM.ins:RegisterPushListener(action, callBack)
end

local NetworkManager = class("NetworkManager")


function NetworkManager:Ctor()
    NM.ins = self
    networkMgr.pushCall = happyCall(self, self.OnPush)
    self.pushListeners = {}
end



function NetworkManager:SendRequest(action, callBack, ...)
    local args = { ... }
    local command = action[1]
    local contentStr = ""
    if #action > 1 then
        local content = {}
        for i = 2, #action do
            content[action[i]] = args[i-1]
        end
        contentStr = JSON.encode(content)
    end

    networkMgr:Send(command, contentStr, function (dataStr)

        DelayedFrameCall(function ()
            --print("NetworkManager 请求返回", dataStr)
            if callBack then
                callBack(JSON.decode(dataStr))
            end
        end)
    end)
end

function NetworkManager:RegisterPushListener(action, callBack)
    if not self.pushListeners[action] then
        self.pushListeners[action] = {}
    end
    table.insert(self.pushListeners[action], callBack)
end

function NetworkManager:OnPush(action, content)
    DelayedFrameCall(function ()
        print("NetworkManager:OnPush", action, content)
        if self.pushListeners[action] then
            for i = 1, #self.pushListeners[action] do
                self.pushListeners[action][i](content)
            end
        end
    end)
end

return NetworkManager