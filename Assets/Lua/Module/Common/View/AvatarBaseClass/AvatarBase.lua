---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by VIVA.
--- DateTime: 2023/2/6 22:13
--- 角色基类
---@class AvatarBase:LuaObj
---@field New fun(prefabPath:string, parent:UnityEngine.Transform):AvatarBase
local AvatarBase = class("AvatarBase", LuaObj)

AvatarBase.ANI_MOVE_NAME="move"
AvatarBase.ANI_IDLE_NAME="idle"
AvatarBase.ANI_ATTACK_NAME="attack"
AvatarBase.ANI_DEAD_NAME="dead"
AvatarBase.ANI_HIT_NAME="hit"
function AvatarBase:Ctor(prefabPath, parent)
    prefabPath = prefabPath
    AvatarBase.super.Ctor(self, prefabPath, nil, parent)

    self.speed = 0
    self.direction = self.transform.localEulerAngles.y

    self.ani = self.gameObject:GetComponentInChildren(typeof(UnityEngine.Animator)) ---@type UnityEngine.Animator
    --self.ani.enabled = false
    if not self.ani then
        return
    end
    self:PlayAnimation(AvatarBase.ANI_IDLE_NAME)
    self:InitAnimations()
end

---初始化动画时长们
function AvatarBase:InitAnimations()
    local clips = self.ani.runtimeAnimatorController.animationClips
    self.clipLens = {}
    for i = 0, clips.Length - 1 do
        local clip = clips[i] ---@type UnityEngine.AnimationClip
        self.clipLens[clip.name] = clip.length
        --print("AvatarBase:InitAnimations", clip.name, clip.length)
    end
end

function AvatarBase:PlayAnimation(name, crossTime, callBack)
    --print("你妹啊~", name, debug.traceback())
    if self.clipLens and not self.clipLens[name] then
        print("没有这个动画！", name, debug.traceback())
        return
    end
    RemoveEventListener(Stage, Event.LATE_UPDATE, self.ChangeAniFrameEnd, self)
    self.changeAniName = nil
    if self.gameObject.activeSelf == true then
        self.changeAniName = name
        AddEventListener(Stage, Event.LATE_UPDATE, self.ChangeAniFrameEnd, self)
    end
    if callBack then
        --print("AvatarBase:PlayAnimation2", name, self.clipLens[name])
        if self.playAnimDelay then
            CancelDelayedCall(self.playAnimDelay)
            self.playAnimDelay = nil
        end
        self.playAnimDelay = DelayedCall(self.clipLens[name], function()
            self.playAnimDelay = nil
            callBack()
        end)
    end
end

---帧末尾执行要修改的动画
function AvatarBase:ChangeAniFrameEnd()
    self.ani:Play(self.changeAniName)
    self.lastAni = self.changeAniName
    self.changeAniName = nil
    RemoveEventListener(Stage, Event.LATE_UPDATE, self.ChangeAniFrameEnd, self)
end

---非寻路移动 时间可控
function AvatarBase:MoveToWorldPos(worldPos, dur, callBack, aniScale)
    self:PlayAnimation(AvatarBase.ANI_MOVE_NAME)
    local moveSpeed = Happy.FrameMoveWithFixedTime(self.transform, worldPos, dur, function()
        self.ani.speed = 1
        self:PlayAnimation(AvatarBase.ANI_IDLE_NAME)
        if callBack then
            callBack()
        end
    end)
    self.ani.speed = moveSpeed * 0.2
end

---朝向目标
---@param target UnityEngine.Transform
function AvatarBase:LookAtTarget(target)
    if not target then
        return
    end
    local nativePos = self.transform.position
    self.transform.forward = target.position - nativePos

    self.transform.position = nativePos
    self.transform.localEulerAngles = Vector3.New(0, self.transform.localEulerAngles.y,0)
end

---朝向目标点
function AvatarBase:LookAtWorldPos(pos)

    local nativePos = self.transform.position
    self.transform.forward = pos - nativePos
    self.transform.position = nativePos
    self.transform.localEulerAngles = Vector3.New(0, self.transform.localEulerAngles.y,0)
end

function AvatarBase:Recycle()
    AvatarBase.super.Recycle(self)
end

function AvatarBase:Show()
    self.ani.enabled = true
    AvatarBase.super.Show(self)
end

function AvatarBase:Hide()
    self.ani.enabled = false
    AvatarBase.super.Hide(self)
end

return AvatarBase